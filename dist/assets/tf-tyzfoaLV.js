const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-nMWMjKKw.js","./index-D3B-3C1D.js","./long-CgdJXaQy.js","./_commonjsHelpers-CE1G-McA.js","./graph_model-D4efRZ2G.js","./index-DToP8jdU.js","./index-BHco0Jqf.js","./face-landmarks-detection.esm-BCE-Cmcy.js","./face_mesh-BYtMtngR.js"])))=>i.map(i=>d[i]);
import{_ as $}from"./preload-helper-DMGCcr4D.js";/* empty css               */const w=document.getElementById("video"),x=document.getElementById("overlay"),O=x.getContext("2d"),k=document.getElementById("head-metrics"),at=document.getElementById("left-eye"),st=document.getElementById("right-eye"),G=document.getElementById("presence"),ct=document.getElementById("left-eye-state"),rt=document.getElementById("right-eye-state"),lt=document.getElementById("attention"),R=document.getElementById("loader");function dt(t="Loading..."){R&&(R.innerHTML=`<div class="box">${t}</div>`,R.classList.remove("hidden"))}const d=document.createElement("canvas"),ht=d.getContext&&d.getContext("2d");d.style.display="none";document.body&&document.body.appendChild(d);function St(){R&&R.classList.add("hidden")}let X=0,U=0,K=0,ft=0;const Lt=1,Ot=3,Ht=2,ut=80;let C=0,yt=0,mt=0,pt=0,xt=0,gt=0,Et=0,wt=!1,D=.22,_t=70,At=70;const Tt=2;let Mt=0;const vt=1024;async function zt(t=2e4){const e=Date.now();try{const n=await $(()=>import("./index-CZVj5_cb.js"),[],import.meta.url);if(n&&typeof n.loadOpenCV=="function"){const o=await n.loadOpenCV();if(o&&(window.cv=o,typeof window.cv.Mat<"u"))return window.cv}}catch{}if(!document.querySelector("script[data-opencv-cdn]")){const n=document.createElement("script");n.setAttribute("data-opencv-cdn","1"),n.src="https://docs.opencv.org/4.7.0/opencv.js",n.async=!0,n.onload=()=>{},n.onerror=()=>{},document.head.appendChild(n)}return new Promise((n,o)=>{function a(){if(window.cv&&typeof window.cv.Mat<"u")return n(window.cv);if(Date.now()-e>t)return o(new Error("OpenCV not found or timed out"));setTimeout(a,100)}a()})}async function Dt(){const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:!1});w.srcObject=t,await w.play(),x.width=w.videoWidth,x.height=w.videoHeight}function Bt(t){O.clearRect(0,0,x.width,x.height),O.fillStyle="rgba(0,200,150,0.9)";for(const e of t){const n=e.x,o=e.y;O.beginPath(),O.arc(n,o,2,0,Math.PI*2),O.fill()}}function S(t,e){const n=e.reduce((o,a)=>({x:o.x+(t[a].x||0),y:o.y+(t[a].y||0),z:o.z+(t[a].z||0)}),{x:0,y:0,z:0});return{x:n.x/e.length,y:n.y/e.length,z:n.z/e.length}}function Z(t,e){const n=t.x-e.x,o=t.y-e.y;return Math.hypot(n,o)}function Ct(t,e){const n=t[e[0]],o=t[e[1]],a=t[e[2]],E=t[e[3]],M=t[e[4]],r=t[e[5]],g=Z(o,r),l=Z(a,M),i=Z(n,E);return i===0?0:(g+l)/(2*i)}const F=[],P=[],Rt=5;function J(t){return t<=-90?t+180:t>=90?t-180:t}function Vt(t){const e=[468,469,470,471,472],n=[473,474,475,476,477];let o,a;try{o=S(t,e),a=S(t,n)}catch{o=S(t,[33,133]),a=S(t,[362,263])}const E=S(t,[33,133]),M=S(t,[362,263]),r={x:(o.x-E.x).toFixed(2),y:(o.y-E.y).toFixed(2)},g={x:(a.x-M.x).toFixed(2),y:(a.y-M.y).toFixed(2)},l=Ct(t,[33,160,158,133,153,144]),i=Ct(t,[263,387,385,362,380,373]);F.push(l),P.push(i),F.length>Rt&&F.shift(),P.length>Rt&&P.shift();const h=F.length?F.reduce((u,_)=>u+_,0)/F.length:0,s=P.length?P.reduce((u,_)=>u+_,0)/P.length:0,y=h>D,c=s>D;let f=1/0,p=1/0,m=-1/0,v=-1/0;for(const u of t)u.x<f&&(f=u.x),u.y<p&&(p=u.y),u.x>m&&(m=u.x),u.y>v&&(v=u.y);const A=m-f,H=v-p,Q=A*H/(x.width*x.height)>.003,I=t[1],T={x:(o.x+a.x)/2,y:(o.y+a.y)/2,z:(o.z+a.z)/2},B={x:I.x-T.x,y:I.y-T.y,z:(I.z||0)-(T.z||0)},tt=Math.atan2(B.x,B.z)*180/Math.PI,et=Math.atan2(-B.y,B.z)*180/Math.PI,nt={x:a.x-o.x,y:a.y-o.y},ot=Math.atan2(nt.y,nt.x)*180/Math.PI,b={pitch:et,yaw:tt,roll:ot,norm:{pitch:J(et),yaw:J(tt),roll:J(ot)}},q=b&&b.norm?b.norm:b,bt=q?Math.abs(q.yaw)<_t&&Math.abs(q.pitch)<At:!1;let z=!0;try{const u=(f+m)/2,_=Math.max(1,m-f),V=I.x-u;Math.abs(V)>.12*_&&(z=!1);const Y=.12*_;(Math.abs(r.x)>Y||Math.abs(g.x)>Y)&&(z=!1)}catch{z=!0}let W=b?bt&&z:z;const it=!(y||c);if(!b)try{const u=Math.max(1,A),_=Math.max(1,H),V={x:I.x,y:I.y},j={x:T.x,y:T.y},Y=V.x-j.x,Ft=V.y-j.y,Pt=.08*u,It=.08*_;Math.abs(Y)<Pt&&Math.abs(Ft)<It&&(W=!0)}catch{}return{angles:b,leftGaze:r,rightGaze:g,avgLeftEAR:h,avgRightEAR:s,attentive:Q&&W&&!it,facingForward:W,eyesClosed:it,present:Q}}let N=null;const Yt=new Promise(t=>{N=t});function L(t){if(typeof N=="function"&&(N(),N=null),!t||t.length===0){G.textContent="Absent",k.textContent="—",at.textContent="—",st.textContent="—",ct.textContent="—",rt.textContent="—",lt.textContent="—",O.clearRect(0,0,x.width,x.height);return}if(Bt(t),!window.cv||typeof window.cv.Mat>"u"){k.textContent="OpenCV loading...",G.textContent="Present (no OpenCV)";return}try{const{angles:e,leftGaze:n,rightGaze:o,avgLeftEAR:a,avgRightEAR:E,attentive:M,facingForward:r,eyesClosed:g,present:l}=Vt(t);if(!wt&&l&&typeof a=="number"&&typeof E=="number"){if(C++,yt+=a,mt+=E,e&&e.yaw!=null&&e.pitch!=null){const h=e.yaw,s=e.pitch;pt+=h,xt+=s,gt+=h*h,Et+=s*s}if(R&&(R.innerHTML=`<div class="box">Calibrating (${C}/${ut})...</div>`),C>=ut){const h=yt/C,s=mt/C,y=(h+s)/2,c=pt/C,f=xt/C,p=Math.max(0,gt/C-c*c),m=Math.max(0,Et/C-f*f),v=Math.sqrt(p),A=Math.sqrt(m);D=Math.min(.28,Math.max(.12,y*.68)),_t=Math.max(15,Math.abs(c)+Math.max(12,v*3)),At=Math.max(15,Math.abs(f)+Math.max(12,A*3)),wt=!0,R&&R.classList.add("hidden")}}G.textContent="Present",e&&(k.textContent=`pitch:${e.pitch.toFixed(1)}° (${e.norm?e.norm.pitch.toFixed(1):"na"}), yaw:${e.yaw.toFixed(1)}° (${e.norm?e.norm.yaw.toFixed(1):"na"})`),at.textContent=`${n.x}, ${n.y}`,st.textContent=`${o.x}, ${o.y}`,r?(X++,U=0):(U++,X=0),g?(ft++,K=0):(K++,ft=0),ct.textContent=F.length>=3?a>D?"Open":"Closed":"—",rt.textContent=P.length>=3?E>D?"Open":"Closed":"—";let i=!1;l?U>=Lt?i=!1:i=X>=Ot&&K>=Ht:i=!1,lt.textContent=i?"Attentive":"Not attentive"}catch{}}async function $t(){try{await zt()}catch{}dt("Loading OpenCV and TensorFlow..."),await Dt(),dt("Starting detection...");let t=null,e=null,n=0,o=null,a=0;const E=1;try{const r=await $(()=>import("./index-nMWMjKKw.js"),__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url);await $(()=>import("./index-BHco0Jqf.js").then(i=>i.b2),__vite__mapDeps([6,1,2,3]),import.meta.url),await r.setBackend("webgl"),await r.ready();const g=await $(()=>import("./face-landmarks-detection.esm-BCE-Cmcy.js"),__vite__mapDeps([7,8,3,1,2,4,5]),import.meta.url),l=g.default||g;if(typeof l.load=="function"){const i=l.SupportedPackages&&l.SupportedPackages.tfjs?l.SupportedPackages.tfjs:"tfjs";t=await l.load(i,{maxFaces:1,refineLandmarks:!0}),e="legacy"}else if(typeof l.createDetector=="function"){const i=l.SupportedModels&&l.SupportedModels.MediaPipeFaceMesh?l.SupportedModels.MediaPipeFaceMesh:Object.values(l.SupportedModels||{})[0],h={runtime:"tfjs",refineLandmarks:!0,maxFaces:1};t=await l.createDetector(i,h),e="detector"}else throw new Error("face-landmarks-detection API not supported")}catch{}async function M(){if(t){try{if(d&&ht&&w.videoWidth&&w.videoHeight){const i=w.videoWidth,h=w.videoHeight,s=Math.max(i,h),y=s>vt?vt/s:1,c=Math.max(1,Math.round(i*y)),f=Math.max(1,Math.round(h*y));(d.width!==c||d.height!==f)&&(d.width=c,d.height=f);try{ht.drawImage(w,0,0,d.width,d.height)}catch{}}Mt++;let r=null;const g=Mt%Tt===0,l=d&&d.width?d:w;if(g&&(e==="legacy"&&typeof t.estimateFaces=="function"?r=await t.estimateFaces({input:l,returnTensors:!1,predictIrises:!0}):e==="detector"&&typeof t.estimateFaces=="function"&&(r=await t.estimateFaces(l))),r&&r.length>0){n=0;const i=r[0],h=i.scaledMesh&&i.scaledMesh.length||i.mesh&&i.mesh.length||i.keypoints&&i.keypoints.length||0,s=r[0];let y=null;if(s.scaledMesh?y=s.scaledMesh:s.mesh?y=s.mesh:s.keypoints&&s.keypoints.length?y=s.keypoints.map(c=>[c.x,c.y,c.z||0]):s.keypoints3D&&(y=s.keypoints3D),y&&y.length){const c=y.map(f=>{let p=f[0],m=f[1],v=f[2]||0;p<=1&&(p=p*d.width),m<=1&&(m=m*d.height);const A=x.width/d.width,H=x.height/d.height;return{x:p*A,y:m*H,z:v*((A+H)/2)}});o=c,a=0,L(c)}}else if(n++,o&&a<E)a++,L(o);else if(n>10&&d&&d.width)try{const i=await createImageBitmap(d);let h=null;if(e==="legacy"&&typeof t.estimateFaces=="function"?h=await t.estimateFaces({input:i,returnTensors:!1,predictIrises:!0}):e==="detector"&&typeof t.estimateFaces=="function"&&(h=await t.estimateFaces(i)),h&&h.length>0){n=0;const s=h[0];let y=s.scaledMesh||s.mesh||s.keypoints&&s.keypoints.map(c=>[c.x,c.y,c.z||0])||s.keypoints3D;if(y&&y.length){const c=y.map(f=>{let p=f[0],m=f[1],v=f[2]||0;return p<=1&&(p=p*x.width),m<=1&&(m=m*x.height),{x:p,y:m,z:v}});o=c,a=0,L(c)}}else L(null)}catch{L(null)}else L(null)}catch{}requestAnimationFrame(M)}else requestAnimationFrame(M)}requestAnimationFrame(M),Promise.race([Yt,new Promise(r=>setTimeout(r,5e3))]).then(()=>St())}$t().catch(()=>{});
