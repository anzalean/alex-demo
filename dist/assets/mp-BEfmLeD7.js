import{_ as pt}from"./preload-helper-DMGCcr4D.js";/* empty css               */import{f as Et}from"./face_mesh-BYtMtngR.js";import"./_commonjsHelpers-CE1G-McA.js";const C=document.getElementById("video"),c=document.getElementById("overlay"),w=c.getContext("2d"),H=document.getElementById("head-metrics"),X=document.getElementById("left-eye"),Z=document.getElementById("right-eye"),L=document.getElementById("presence"),J=document.getElementById("left-eye-state"),K=document.getElementById("right-eye-state"),Q=document.getElementById("attention"),F=document.getElementById("loader");function k(t="Loading..."){F&&(F.innerHTML=`<div class="box">${t}</div>`,F.classList.remove("hidden"))}function wt(){F&&F.classList.add("hidden")}let T=0,V=0,b=0,tt=0;const xt=1,Ct=3,Ft=2;async function Rt(t=2e4){const e=Date.now();try{const n=await pt(()=>import("./index-CZVj5_cb.js"),[],import.meta.url);if(n&&typeof n.loadOpenCV=="function"){const o=await n.loadOpenCV();if(o&&(window.cv=o,typeof window.cv.Mat<"u"))return window.cv}}catch(n){console.warn("dynamic import/loadOpenCV failed:",n)}if(!document.querySelector("script[data-opencv-cdn]")){const n=document.createElement("script");n.setAttribute("data-opencv-cdn","1"),n.src="https://docs.opencv.org/4.7.0/opencv.js",n.async=!0,n.onload=()=>console.log("OpenCV CDN script loaded"),n.onerror=()=>console.warn("Failed to load OpenCV from CDN"),document.head.appendChild(n)}return new Promise((n,o)=>{function s(){if(window.cv&&typeof window.cv.Mat<"u")return n(window.cv);if(Date.now()-e>t)return o(new Error("OpenCV not found or timed out"));setTimeout(s,100)}s()})}async function vt(){const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:!1});C.srcObject=t,await C.play(),c.width=C.videoWidth,c.height=C.videoHeight}function At(t){w.clearRect(0,0,c.width,c.height),w.fillStyle="rgba(0,200,150,0.9)";for(const e of t){const n=e.x*c.width,o=e.y*c.height;w.beginPath(),w.arc(n,o,2,0,Math.PI*2),w.fill()}}function E(t,e){const n=e.reduce((o,s)=>({x:o.x+t[s].x,y:o.y+t[s].y}),{x:0,y:0});return{x:n.x/e.length,y:n.y/e.length}}function S(t,e){const n=(t.x-e.x)*c.width,o=(t.y-e.y)*c.height;return Math.hypot(n,o)}function et(t,e){const n=t[e[0]],o=t[e[1]],s=t[e[2]],l=t[e[3]],h=t[e[4]],u=t[e[5]],f=S(o,u),y=S(s,h),a=S(n,l);return a===0?0:(f+y)/(2*a)}const g=[],p=[],nt=5;function Mt(t){const e=t[0];t[1],t[2];const n=t[3],o=t[4],s=t[5],l=t[6],h=t[7],u=t[8],f=Math.sqrt(e*e+n*n),y=f<1e-6;let a,r,m;return y?(a=Math.atan2(-s,o),r=Math.atan2(-l,f),m=0):(a=Math.atan2(h,u),r=Math.atan2(-l,f),m=Math.atan2(n,e)),{pitch:a*180/Math.PI,yaw:r*180/Math.PI,roll:m*180/Math.PI}}function B(t){return t<=-90?t+180:t>=90?t-180:t}function _t(t,e){const n=[1,152,33,263,61,291],o=[];for(const i of n)o.push(e[i].x*c.width),o.push(e[i].y*c.height);const s=[0,0,0,0,-330,-65,-225,170,-135,225,170,-135,-150,-150,-125,150,-150,-125],l=t.matFromArray(6,3,t.CV_64F,s),h=t.matFromArray(6,2,t.CV_64F,o),u=c.width,f=c.width/2,y=c.height/2,a=t.matFromArray(3,3,t.CV_64F,[u,0,f,0,u,y,0,0,1]),r=new t.Mat.zeros(4,1,t.CV_64F),m=new t.Mat,$=new t.Mat,ot=t.solvePnP(l,h,a,r,m,$,!1,t.SOLVEPNP_ITERATIVE);let d=null;if(ot){const i=new t.Mat;t.Rodrigues(m,i);const x=new Float64Array(i.data64F);d=Mt(x),d.norm={pitch:B(d.pitch),yaw:B(d.yaw),roll:B(d.roll)},i.delete()}const it=[468,469,470,471,472],ct=[473,474,475,476,477];let R,v;try{R=E(e,it),v=E(e,ct)}catch{R=E(e,[33,133]),v=E(e,[362,263])}const N=E(e,[33,133]),z=E(e,[362,263]),st={x:(R.x-N.x).toFixed(4),y:(R.y-N.y).toFixed(4)},at={x:(v.x-z.x).toFixed(4),y:(v.y-z.y).toFixed(4)},rt=et(e,[33,160,158,133,153,144]),dt=et(e,[263,387,385,362,380,373]);g.push(rt),p.push(dt),g.length>nt&&g.shift(),p.length>nt&&p.shift();const j=g.length?g.reduce((i,x)=>i+x,0)/g.length:0,G=p.length?p.reduce((i,x)=>i+x,0)/p.length:0,Y=.22,lt=j>Y,ft=G>Y;let M=1,_=1,P=0,O=0;for(const i of e)i.x<M&&(M=i.x),i.y<_&&(_=i.y),i.x>P&&(P=i.x),i.y>O&&(O=i.y);const ht=(P-M)*c.width,ut=(O-_)*c.height,U=ht*ut/(c.width*c.height)>.003,yt=50,mt=50,I=d&&d.norm?d.norm:d,W=I?Math.abs(I.yaw)<yt&&Math.abs(I.pitch)<mt:!1,q=!(lt||ft),gt=U&&W&&!q;return l.delete(),h.delete(),a.delete(),r.delete(),m.delete(),$.delete(),{angles:d,leftGaze:st,rightGaze:at,avgLeftEAR:j,avgRightEAR:G,attentive:gt,facingForward:W,eyesClosed:q,present:U}}let A=null;const Pt=new Promise(t=>{A=t});function Ot(t){if(typeof A=="function"&&(A(),A=null),!t.multiFaceLandmarks||t.multiFaceLandmarks.length===0){L.textContent="Absent",H.textContent="—",X.textContent="—",Z.textContent="—",J.textContent="—",K.textContent="—",Q.textContent="—",w.clearRect(0,0,c.width,c.height);return}const e=t.multiFaceLandmarks[0];if(At(e),!window.cv||typeof window.cv.Mat>"u"){H.textContent="OpenCV loading...",L.textContent="Present (no OpenCV)";return}try{const{angles:n,leftGaze:o,rightGaze:s,avgLeftEAR:l,avgRightEAR:h,attentive:u,facingForward:f,eyesClosed:y,present:a}=_t(window.cv,e);L.textContent="Present",n&&(H.textContent=`pitch:${n.pitch.toFixed(1)}° (${n.norm?n.norm.pitch.toFixed(1):"na"}), yaw:${n.yaw.toFixed(1)}° (${n.norm?n.norm.yaw.toFixed(1):"na"})`),X.textContent=`${o.x}, ${o.y}`,Z.textContent=`${s.x}, ${s.y}`,f?(T++,V=0):(V++,T=0),y?(tt++,b=0):(b++,tt=0),J.textContent=g.length>=3?l>.22?"Open":"Closed":"—",K.textContent=p.length>=3?h>.22?"Open":"Closed":"—";let r=!1;a?V>=xt?r=!1:r=T>=Ct&&b>=Ft:r=!1,Q.textContent=r?"Attentive":"Not attentive"}catch(n){console.error("compute error",n)}}const D=new Et.FaceMesh({locateFile:t=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${t}`});D.setOptions({maxNumFaces:1,refineLandmarks:!0,minDetectionConfidence:.5,minTrackingConfidence:.5});D.onResults(Ot);async function It(){try{const e=await Rt();console.log("OpenCV ready",!!e&&typeof e.Mat<"u")}catch(e){console.warn("OpenCV init warning:",e)}k("Loading OpenCV and MediaPipe..."),await vt(),k("Starting video processing...");async function t(){await D.send({image:C}),requestAnimationFrame(t)}t(),await Promise.race([Pt,new Promise(e=>setTimeout(e,5e3))]),wt()}It().catch(console.error);
